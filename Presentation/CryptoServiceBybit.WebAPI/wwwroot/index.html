<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CryptoService Bybit</title>
    <style>
        td {
            padding: 15px;
        }
    </style>
</head>
<body>
    <h2>CryptoService Bybit</h2>
    <p>
        <label>Symbol:</label>
        <select id="listSymbolsSelect" name="symbols"></select>

        <label style="margin: 10px">Timeframe:</label>
        <select id="listTimeframesSelect" name="timeframes">
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="120">120</option>
            <option value="240">240</option>
            <option value="360">360</option>
            <option value="720">720</option>
            <option value="D">D</option>
            <option value="W">W</option>
            <option value="M">M</option>
        </select>
    </p>
    <p>
        <label>Category</label>
        <select id="listCategoriesSelect" name="category">
            <option value="spot">Spot</option>
            <option value="inverse">Inverse</option>
        </select>
    </p>
    <p>
        <label>Info about </label>
        <label id="selectedSymbolLbl"></label>
        <button id="updatePriceBtn">Update price</button>
    </p>
    <p>
        <table id="tablePrices">
            <caption><b>Prices</b></caption>
            <thead>
                <tr>
                    <td>Date</td>
                    <td>Open</td>
                    <td>High</td>
                    <td>Low</td>
                    <td>Close</td>
                </tr>
            </thead>
            <tbody id="tablePricesBody">
            </tbody>
        </table>
    </p>
    <script>
        let currentSymbol;
        let currentCategory;
        let currentTimeframe;

        async function init() {
            await getTickers("spot", true);
            changeCurrentSymbol();
            changeCurrentCategory();
            changeCurrentTimeframe();
        }

        async function getTickers(categoryStr) {
            const response = await fetch(`/api/tickers/${categoryStr}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const responseJson = await response.json();
                const listTickers = responseJson.result.list;

                const listSymbolsElement = document.getElementById("listSymbolsSelect");
                removeOptions(listSymbolsElement);
                for (let i = 0; i < listTickers.length; ++i) {
                    const optionElement = document.createElement("option");
                    const symbol = listTickers[i].symbol;
                    optionElement.value = symbol;
                    optionElement.text = symbol;
                    listSymbolsElement.append(optionElement);
                }
            }
        }

        async function updatePriceByCurrentSymbol(symbol, category, timeframe) {
            const response = await fetch(`/api/market/kline/${category}/${symbol}?timeframe=${timeframe}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const responseJson = await response.json();
                console.log(responseJson);
                const priceList = responseJson.result.list;

                const tablePrices = document.getElementById("tablePricesBody");
                tablePrices.innerHTML = "";
                priceList.forEach(e => tablePrices.append(this.row(e)));
            }
        }

        function removeOptions(selectElement) {
            const length = selectElement.options.length;
            if (length == 0) {
                return;
            }
            for (i = length - 1; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

        function changeCurrentSymbol() {
            const symbolsListElement = document.getElementById("listSymbolsSelect");
            const selectedSymbolInList = symbolsListElement.options[symbolsListElement.selectedIndex];
            const selectedSymbolLbl = document.getElementById("selectedSymbolLbl");
            selectedSymbolLbl.value = selectedSymbolInList.value;
            selectedSymbolLbl.textContent = selectedSymbolInList.value;
            currentSymbol = selectedSymbolInList.value;
        }

        function changeCurrentCategory() {
            const categoriesListElement = document.getElementById("listCategoriesSelect");
            const selectedCategory = categoriesListElement.options[categoriesListElement.selectedIndex];
            currentCategory = selectedCategory.value;
        }

        function changeCurrentTimeframe() {
            const timeframesListElement = document.getElementById("listTimeframesSelect");
            const selectedTimeframe = timeframesListElement.options[timeframesListElement.selectedIndex];
            currentTimeframe = selectedTimeframe.value;
        }

        function row(priceInfo) {
            const date = priceInfo[0];
            const open = priceInfo[1];
            const high = priceInfo[2];
            const low = priceInfo[3];
            const close = priceInfo[4];

            const trElement = document.createElement("tr");

            const humanReadableDate = new Date(Number(date));

            const dateTd = document.createElement("td");
            dateTd.append(humanReadableDate.toLocaleString());
            trElement.append(dateTd);

            const openTd = document.createElement("td");
            openTd.append(open);
            trElement.append(openTd);

            const highTd = document.createElement("td");
            highTd.append(high);
            trElement.append(highTd);

            const lowTd = document.createElement("td");
            lowTd.append(low);
            trElement.append(lowTd);

            const closeTd = document.createElement("td");
            closeTd.append(close);
            trElement.append(closeTd);

            return trElement;
        }

        const symbolsListElement = document.getElementById("listSymbolsSelect");
        symbolsListElement.addEventListener("change", async () => {
            changeCurrentSymbol();

            await updatePriceByCurrentSymbol(currentSymbol, currentCategory, currentTimeframe);
        });

        const categoriesListElement = document.getElementById("listCategoriesSelect");
        categoriesListElement.addEventListener("change", async () => {
            const selectedCategory = categoriesListElement.options[categoriesListElement.selectedIndex];
            currentCategory = selectedCategory.value;
            await getTickers(selectedCategory.value);
            changeCurrentSymbol();

            await updatePriceByCurrentSymbol(currentSymbol, currentCategory, currentTimeframe);
        });

        const timeframesListElemnt = document.getElementById("listTimeframesSelect")
        timeframesListElemnt.addEventListener("change", async () => {
            changeCurrentTimeframe();

            await updatePriceByCurrentSymbol(currentSymbol, currentCategory, currentTimeframe);
        });

        const updatePriceBtnElement = document.getElementById("updatePriceBtn");
        updatePriceBtnElement.addEventListener("click", async () => {
            await updatePriceByCurrentSymbol(currentSymbol, currentCategory, currentTimeframe);
        });

        init();
    </script>
</body>
</html>